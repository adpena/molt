name: Perf Demo Nightly

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

jobs:
  demo-perf:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"
      - name: Set up Python 3.12
        run: uv python install 3.12
      - name: Install deps (accel + dev)
        run: uv sync --frozen --python 3.12 --dev
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Rust cache
        uses: swatinem/rust-cache@v2
      - name: Install k6
        run: |
          if ! command -v k6 >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y ca-certificates curl gnupg
            curl -fsSL https://dl.k6.io/key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/k6-archive-keyring.gpg
            echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list >/dev/null
            sudo apt-get update
            sudo apt-get install -y k6
          fi
      - name: Run demo stack + k6
        run: |
          chmod +x bench/scripts/run_stack.sh
          ./bench/scripts/run_stack.sh
      - name: Check regressions (p95 thresholds)
        run: |
          latest=$(ls -1 bench/results/demo_k6_*.json | sort | tail -n 1)
          python - <<'PY'
          import json, sys, pathlib
          path = pathlib.Path("bench/results").glob("demo_k6_*.json")
          latest = sorted(path)[-1]
          data = json.loads(latest.read_text())
          def p95(block):
              return block.get("metrics", {}).get("http_req_duration", {}).get("percentiles", {}).get("95", 0.0)
          thresholds = {"baseline": 1000.0, "offload": 1000.0, "offload_table": 1500.0}
          for key, limit in thresholds.items():
              block = data.get(key, {})
              val = p95(block)
              if val > limit:
                  print(f"REGRESSION: {key} p95 {val}ms > {limit}ms")
                  sys.exit(1)
          print("Perf check OK")
          PY
      - name: Upload k6 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: demo-k6
          path: bench/results/*.json
