# Molt CI Plan (GitHub Actions)

Minimum required pre-merge gates are defined in
`docs/spec/areas/testing/0008_MINIMUM_MUST_PASS_MATRIX.md`.

Status: Active
Last updated: 2026-02-11

## 1. Pipeline Overview
Molt uses a unified GitHub Actions pipeline for both the Python compiler and the Rust runtime.

## 1.1 Required Gate Mapping (Must-Pass Matrix)

| Matrix Gate | CI Job | Required Command |
| --- | --- | --- |
| G0 | `rust-check` | `cargo check -p molt-runtime -p molt-backend` |
| G1 | `python-lint` | `uv run --python 3.12 python3 tools/dev.py lint` |
| G2 | `lowering-smoke` | `uv run --python 3.12 python3 tools/check_molt_ir_ops.py && uv run --python 3.12 pytest -q tests/test_codec_lowering.py` |
| G3 | `diff-basic` | `MOLT_DIFF_MEASURE_RSS=1 MOLT_DIFF_RLIMIT_GB=10 MOLT_DIFF_TIMEOUT=180 MOLT_DIFF_FAILURES=ir_probe_failures.txt uv run --python 3.12 python3 -u tests/molt_diff.py tests/differential/basic && uv run --python 3.12 python3 tools/check_molt_ir_ops.py --require-probe-execution --probe-rss-metrics rss_metrics.jsonl --failure-queue ir_probe_failures.txt` |
| G4 | `py-matrix` | `uv run --python 3.12 python3 tools/dev.py test` |
| G5 | `regrtest` (periodic/pre-release) | `uv run --python 3.12 python3 tools/cpython_regrtest.py --uv --uv-python 3.12 --uv-prepare` |
| G6 | `runtime-feedback` | `PYTHONPATH=src MOLT_PROFILE=1 MOLT_RUNTIME_FEEDBACK=1 MOLT_RUNTIME_FEEDBACK_FILE=target/molt_runtime_feedback_gate.json uv run --python 3.12 python3 -m molt.cli run --profile dev examples/hello.py && uv run --python 3.12 python3 tools/check_runtime_feedback.py target/molt_runtime_feedback_gate.json` |

Required CI policy notes:
- Differential jobs must keep `MOLT_DIFF_MEASURE_RSS=1`.
- Diff jobs should enforce `MOLT_DIFF_RLIMIT_GB=10` unless explicitly disabled for investigation.
- Release/perf lanes should use explicit `--profile release`; development lanes use `--profile dev`.
- Dedicated IR probe hardening is a required CI gate after `diff-basic`:
  `tools/check_molt_ir_ops.py --require-probe-execution` validates required probe execution status from `rss_metrics.jsonl` and enforces failure-queue linkage.
- Runtime-feedback schema enforcement (G6) requires deopt-reason counters for
  `CALL_INDIRECT` non-callable, `INVOKE_FFI` bridge-capability-denied,
  `GUARD_TAG` type-mismatch, and `GUARD_DICT_SHAPE` layout-mismatch lanes,
  including per-reason guard-layout mismatch breakdown keys.

## 2. Jobs

### 2.1 Python (Compiler & Tooling)
- **Environment**: `ubuntu-latest`.
- **Steps**:
    - Install `uv`.
    - `uv python install <version>`.
    - `uv sync --frozen --python <version>`.
    - `uv run --python <version> ruff check .` (Linting).
    - `uv run --python <version> ty check src` (Static typing).
    - `uv run --python <version> pytest` (Python tests in `tests/`).

### 2.2 Rust (Runtime & Core)
- **Environment**: `ubuntu-latest`.
- **Steps**:
    - Install Rust toolchain with `clippy` and `rustfmt`.
    - `cargo fmt --check`.
    - `cargo clippy -- -D warnings`.
    - `cargo test`.

### 2.3 Integration & Differential
- Build the Molt runtime (release).
- Run curated `molt-diff` parity cases against CPython 3.12+ (minimum 3.12) (`tests/differential/basic/`).
  - Use `uv run --python <version> python3 tools/verified_subset.py run` to execute the verified subset suite.

### 2.4 WASM Parity
- Dedicated job to run `tests/test_wasm_control_flow.py` with Node + Rust toolchain.

### 2.5 Performance & Artifacts (planned) (TODO(tooling, owner:tooling, milestone:TL2, priority:P2, status:planned): CI perf artifacts + release uploads)
- Run `tools/bench.py` for regression checks.
- Upload benchmark results as PR artifacts or comments.
- Build and upload release binaries for macOS (arm64) and Linux (x86_64, arm64).

## 3. Caching Strategy (recommended)
- **Python**: Cache `~/.cache/uv`.
- **Rust**: Cache `target/` and `~/.cargo/registry` using `swatinem/rust-cache`.
- **WASM**: Cache pre-compiled Molt Packages when WASM packages land.

## 4. Release Trigger
- Tagging a version (`vX.Y.Z`) triggers a full release build with signed binaries and SBOM generation.
