use std::sync::atomic::{AtomicU64, Ordering as AtomicOrdering};

use super::RuntimeState;
use crate::dec_ref_bits;

pub(crate) fn clear_atomic_bits(slot: &AtomicU64) {
    let bits = slot.swap(0, AtomicOrdering::AcqRel);
    if bits != 0 {
        dec_ref_bits(bits);
    }
}

pub(crate) fn clear_atomic_slots(slots: &[&AtomicU64]) {
    for slot in slots {
        clear_atomic_bits(slot);
    }
}

pub(crate) fn clear_method_cache(state: &RuntimeState) {
    let slots = method_cache_slots(state);
    clear_atomic_slots(&slots);
}

fn method_cache_slots(state: &RuntimeState) -> Vec<&AtomicU64> {
    vec![
        &state.method_cache.dict_keys,
        &state.method_cache.dict_values,
        &state.method_cache.dict_items,
        &state.method_cache.dict_get,
        &state.method_cache.dict_pop,
        &state.method_cache.dict_clear,
        &state.method_cache.dict_copy,
        &state.method_cache.dict_popitem,
        &state.method_cache.dict_setdefault,
        &state.method_cache.dict_update,
        &state.method_cache.dict_fromkeys,
        &state.method_cache.dict_getitem,
        &state.method_cache.dict_setitem,
        &state.method_cache.dict_delitem,
        &state.method_cache.dict_iter,
        &state.method_cache.dict_len,
        &state.method_cache.dict_contains,
        &state.method_cache.dict_reversed,
        &state.method_cache.set_add,
        &state.method_cache.set_discard,
        &state.method_cache.set_remove,
        &state.method_cache.set_pop,
        &state.method_cache.set_iter,
        &state.method_cache.set_len,
        &state.method_cache.set_contains,
        &state.method_cache.frozenset_iter,
        &state.method_cache.frozenset_len,
        &state.method_cache.frozenset_contains,
        &state.method_cache.list_append,
        &state.method_cache.list_extend,
        &state.method_cache.list_insert,
        &state.method_cache.list_remove,
        &state.method_cache.list_pop,
        &state.method_cache.list_clear,
        &state.method_cache.list_copy,
        &state.method_cache.list_reverse,
        &state.method_cache.list_count,
        &state.method_cache.list_index,
        &state.method_cache.list_sort,
        &state.method_cache.list_getitem,
        &state.method_cache.list_setitem,
        &state.method_cache.list_delitem,
        &state.method_cache.list_iter,
        &state.method_cache.list_len,
        &state.method_cache.list_contains,
        &state.method_cache.list_reversed,
        &state.method_cache.str_iter,
        &state.method_cache.str_len,
        &state.method_cache.str_contains,
        &state.method_cache.str_count,
        &state.method_cache.str_startswith,
        &state.method_cache.str_endswith,
        &state.method_cache.str_upper,
        &state.method_cache.str_lower,
        &state.method_cache.str_strip,
        &state.method_cache.str_lstrip,
        &state.method_cache.str_rstrip,
        &state.method_cache.str_split,
        &state.method_cache.str_rsplit,
        &state.method_cache.str_splitlines,
        &state.method_cache.str_partition,
        &state.method_cache.str_rpartition,
        &state.method_cache.str_replace,
        &state.method_cache.str_join,
        &state.method_cache.str_encode,
        &state.method_cache.bytes_iter,
        &state.method_cache.bytes_len,
        &state.method_cache.bytes_contains,
        &state.method_cache.bytes_count,
        &state.method_cache.bytes_startswith,
        &state.method_cache.bytes_endswith,
        &state.method_cache.bytes_find,
        &state.method_cache.bytes_rfind,
        &state.method_cache.bytes_split,
        &state.method_cache.bytes_rsplit,
        &state.method_cache.bytes_reversed,
        &state.method_cache.bytes_strip,
        &state.method_cache.bytes_lstrip,
        &state.method_cache.bytes_rstrip,
        &state.method_cache.bytes_splitlines,
        &state.method_cache.bytes_partition,
        &state.method_cache.bytes_rpartition,
        &state.method_cache.bytes_replace,
        &state.method_cache.bytes_decode,
        &state.method_cache.bytearray_iter,
        &state.method_cache.bytearray_len,
        &state.method_cache.bytearray_contains,
        &state.method_cache.bytearray_count,
        &state.method_cache.bytearray_startswith,
        &state.method_cache.bytearray_endswith,
        &state.method_cache.bytearray_find,
        &state.method_cache.bytearray_rfind,
        &state.method_cache.bytearray_split,
        &state.method_cache.bytearray_rsplit,
        &state.method_cache.bytearray_reversed,
        &state.method_cache.bytearray_strip,
        &state.method_cache.bytearray_lstrip,
        &state.method_cache.bytearray_rstrip,
        &state.method_cache.bytearray_splitlines,
        &state.method_cache.bytearray_partition,
        &state.method_cache.bytearray_rpartition,
        &state.method_cache.bytearray_replace,
        &state.method_cache.bytearray_decode,
        &state.method_cache.bytearray_setitem,
        &state.method_cache.bytearray_delitem,
        &state.method_cache.slice_indices,
        &state.method_cache.slice_hash,
        &state.method_cache.slice_eq,
        &state.method_cache.slice_reduce,
        &state.method_cache.slice_reduce_ex,
        &state.method_cache.memoryview_tobytes,
        &state.method_cache.memoryview_cast,
        &state.method_cache.memoryview_setitem,
        &state.method_cache.memoryview_delitem,
        &state.method_cache.file_read,
        &state.method_cache.file_readline,
        &state.method_cache.file_readlines,
        &state.method_cache.file_readinto,
        &state.method_cache.file_write,
        &state.method_cache.file_writelines,
        &state.method_cache.file_flush,
        &state.method_cache.file_close,
        &state.method_cache.file_detach,
        &state.method_cache.file_reconfigure,
        &state.method_cache.file_seek,
        &state.method_cache.file_tell,
        &state.method_cache.file_fileno,
        &state.method_cache.file_truncate,
        &state.method_cache.file_readable,
        &state.method_cache.file_writable,
        &state.method_cache.file_seekable,
        &state.method_cache.file_isatty,
        &state.method_cache.file_iter,
        &state.method_cache.file_next,
        &state.method_cache.file_enter,
        &state.method_cache.file_exit,
        &state.method_cache.asyncgen_aiter,
        &state.method_cache.asyncgen_anext,
        &state.method_cache.asyncgen_asend,
        &state.method_cache.asyncgen_athrow,
        &state.method_cache.asyncgen_aclose,
        &state.method_cache.object_getattribute,
        &state.method_cache.object_setattr,
        &state.method_cache.object_delattr,
        &state.method_cache.object_eq,
        &state.method_cache.object_ne,
        &state.method_cache.exception_init,
        &state.method_cache.exception_new,
    ]
}
